{
    "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "Mission Landing Zone Spoke (Tier-3) Application Gateway",
            "steps": [
                {
                    "name": "basics",
                    "label": "Basics",
                    "elements": [
                        {
                            "name": "basicsDescriptionTextBlock",
                            "type": "Microsoft.Common.TextBlock",
                            "options": {
                                "text": "Mission Landing Zone is a prescriptive reference architecture with reference implementation of a SCCA compliant Hub and Spoke virtual network provided by Microsoft.",
                                "link": {
                                    "label": "https://aka.ms/missionlz",
                                    "uri": "https://aka.ms/missionlz"
                                }
                            }
                        },
                        {
                            "name": "armApiControls",
                            "label": "",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "subscriptionApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "subscriptions?api-version=2020-01-01"
                                    }
                                },
                                {
                                    "name": "locationsApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "locations?api-version=2019-11-01"
                                    }
                                }
                            ]
                        },
                        {
                            "name": "selectSubscriptions",
                            "label": "Select Subscription(s)",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "subscriptionDetailsText",
                                    "type": "Microsoft.Common.TextBlock",
                                    "options": {
                                        "text": "Mission Landing Zone is configured for deployment into a single subscription or many subscriptions depending on your needs for resource counts, subscription boundaries, or billing."
                                    }
                                }
                            ]
                        },
                        {
                            "name": "hubSection",
                            "label": "Hub",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "hubSectionTextBlock",
                                    "type": "Microsoft.Common.TextBlock",
                                    "options": {
                                        "text": "All network traffic is directed through the Azure Firewall residing in the Hub Virtual Network and houses the Azure Bastion host for secure remote access into the network."
                                    }
                                },
                                {
                                    "name": "hubSubscriptionId",
                                    "label": "Hub Subscription",
                                    "type": "Microsoft.Common.DropDown",
                                    "defaultValue": "",
                                    "toolTip": "Select the Subscription for your Mission Landing Zone Hub network, firewall, and remote access resources.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(steps('basics').armApiControls.subscriptionApi.value, (item) => parse(concat('{\"label\":\"', item.displayName, '\",\"value\":\"', item.id, '\",\"description\":\"', 'ID: ', item.subscriptionId, '\"}')))]",
                                        "required": true
                                    }
                                }
                            ]
                        },
                        {
                            "name": "spokeSection",
                            "label": "Tier-3 Spoke Subscription",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "identitySectionTextBlock",
                                    "type": "Microsoft.Common.TextBlock",
                                    "options": {
                                        "text": "The Tier-3 spoke will be used to house the Application Gateway other resources for the application."
                                    }
                                },
                                {
                                    "name": "spokeSubscriptionId",
                                    "label": "Tier-3 Spoke Subscription",
                                    "type": "Microsoft.Common.DropDown",
                                    "defaultValue": "",
                                    "toolTip": "Select the Subscription for your Mission Landing Zone Tier3-Spoke and other resources for the application.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(steps('basics').armApiControls.subscriptionApi.value, (item) => parse(concat('{\"label\":\"', item.displayName, '\",\"value\":\"', item.id, '\",\"description\":\"', 'ID: ', item.subscriptionId, '\"}')))]",
                                        "required": true
                                    }
                                }
                            ]
                        },
                        {
                            "name": "locationSection",
                            "label": "Location",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "infoBoxLocation",
                                    "type": "Microsoft.Common.InfoBox",
                                    "options": {
                                        "text": "Since not all service features are available in all regions, Mission Landing Zone is available in a subset of regions.",
                                        "style": "Info"
                                    }
                                },
                                {
                                    "name": "location",
                                    "label": "Location",
                                    "type": "Microsoft.Common.DropDown",
                                    "defaultValue": "",
                                    "toolTip": "Select the Location for your Mission Landing Zone.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(filter(steps('basics').armApiControls.locationsApi.value,(item) => contains(split('eastus,eastus2,southcentralus,westus,westus2,usgovvirginia,usgovarizona,ussec,usnat', ','), item.name)),(item) => parse(concat('{\"label\":\"', item.regionalDisplayName, '\",\"value\":\"', item.name, '\"}')))]",
                                        "required": true
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "hub",
                    "label": "Hub",
                    "elements": [
                        {
                            "name": "hubResources",
                            "type": "Microsoft.Common.Section",
                            "label": "Mission Landing Zone Hub",
                            "elements": [
                                {
                                    "name": "firewall",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Select MLZ Hub Azure Firewall",
                                    "resourceType": "Microsoft.Network/azureFirewalls",
                                    "scope": {
                                        "subscriptionId": "[replace(steps('basics').hubSection.hubSubscriptionId, '/subscriptions/', '')]"
                                    }
                                },
                                {
                                    "name": "hubVirtualNetwork",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Select MLZ Hub Virtual Network",
                                    "resourceType": "Microsoft.Network/virtualNetworks",
                                    "scope": {
                                        "subscriptionId": "[replace(steps('basics').hubSection.hubSubscriptionId, '/subscriptions/', '')]"
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "spoke",
                    "label": "Spoke",
                    "elements": [
                        {
                            "name": "spokeResourceGroupName",
                            "label": "Spoke Resource Group",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "vmCredentials",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Spoke Resource Group Name",
                                    "defaultValue": "",
                                    "constraints": {
                                        "required": true
                                    }
                                }
                            ]
                        },
                        {
                            "name": "spokeVirtualNetwork",
                            "label": "Spoke Virtual Network",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "spokeVirtualNetworkAddressCidrRange",
                                    "label": "Spoke Virtual Network CIDR Range",
                                    "type": "Microsoft.Common.TextBox",
                                    "defaultValue": "172.23.0.0/16",
                                    "toolTip": "Specify an address CIDR range within the range [10,26].",
                                    "constraints": {
                                        "required": true,
                                        "validations": [
                                            {
                                                "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(1[0-9]|2[0-6]))$",
                                                "message": "Invalid CIDR range. The address prefix must be in the range [10,26]."
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "appGwSubnetAddressCidrRange",
                                    "label": "Application Gateway Subnet Range",
                                    "type": "Microsoft.Common.TextBox",
                                    "defaultValue": "172.23.1.0/24",
                                    "toolTip": "Specify a CIDR range for the Application Gateway subnet within the Spoke Virtual Network range [10,24].",
                                    "constraints": {
                                        "required": true,
                                        "validations": [
                                            {
                                                "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(1[0-9]|2[0-6]))$",
                                                "message": "Invalid CIDR range. The address prefix must be in the range [10,26]."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 8), equals(last(take(split(first(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 1)), last(take(split(first(split(steps('spoke').spokeVirtualNetwork.appGwSubnetAddressCidrRange, '/')), '.'), 1))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (first octet)."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 16), equals(last(take(split(first(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 2)), last(take(split(first(split(steps('spoke').spokeVirtualNetwork.appGwSubnetAddressCidrRange, '/')), '.'), 2))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (second octet)."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 24), equals(last(take(split(first(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 3)), last(take(split(first(split(steps('spoke').spokeVirtualNetwork.appGwSubnetAddressCidrRange, '/')), '.'), 3))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (third octet)."
                                            },
                                            {
                                                "isValid": "[lessOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), last(split(steps('spoke').spokeVirtualNetwork.appGwSubnetAddressCidrRange, '/')))]",
                                                "message": "CIDR range not within virtual network CIDR range (subnet mask)."
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "mgmtSubnetAddressCidrRange",
                                    "label": "Management Virtual Machine Subnet Range",
                                    "type": "Microsoft.Common.TextBox",
                                    "defaultValue": "172.23.2.0/24",
                                    "toolTip": "Specify a CIDR range for the Management Virtual Machine subnet within the Spoke Virtual Network range [10,24].",
                                    "constraints": {
                                        "required": true,
                                        "validations": [
                                            {
                                                "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(1[0-9]|2[0-6]))$",
                                                "message": "Invalid CIDR range. The address prefix must be in the range [10,26]."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 8), equals(last(take(split(first(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 1)), last(take(split(first(split(steps('spoke').spokeVirtualNetwork.mgmtSubnetAddressCidrRange, '/')), '.'), 1))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (first octet)."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 16), equals(last(take(split(first(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 2)), last(take(split(first(split(steps('spoke').spokeVirtualNetwork.mgmtSubnetAddressCidrRange, '/')), '.'), 2))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (second octet)."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 24), equals(last(take(split(first(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 3)), last(take(split(first(split(steps('spoke').spokeVirtualNetwork.mgmtSubnetAddressCidrRange, '/')), '.'), 3))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (third octet)."
                                            },
                                            {
                                                "isValid": "[lessOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), last(split(steps('spoke').spokeVirtualNetwork.mgmtSubnetAddressCidrRange, '/')))]",
                                                "message": "CIDR range not within virtual network CIDR range (subnet mask)."
                                            }
                                        ]
                                    }
                                },
                                {
                                    "name": "aseSubnetAddressCidrRange",
                                    "label": "App Service Environment Subnet",
                                    "type": "Microsoft.Common.TextBox",
                                    "defaultValue": "172.23.3.0/24",
                                    "toolTip": "Specify a CIDR range for the App Service Environment subnet within the Spoke Virtual Network range [10,24].",
                                    "constraints": {
                                        "required": true,
                                        "validations": [
                                            {
                                                "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\/(1[0-9]|2[0-6]))$",
                                                "message": "Invalid CIDR range. The address prefix must be in the range [10,26]."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 8), equals(last(take(split(first(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 1)), last(take(split(first(split(steps('spoke').spokeVirtualNetwork.aseSubnetAddressCidrRange, '/')), '.'), 1))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (first octet)."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 16), equals(last(take(split(first(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 2)), last(take(split(first(split(steps('spoke').spokeVirtualNetwork.aseSubnetAddressCidrRange, '/')), '.'), 2))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (second octet)."
                                            },
                                            {
                                                "isValid": "[if(greaterOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), 24), equals(last(take(split(first(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), '.'), 3)), last(take(split(first(split(steps('spoke').spokeVirtualNetwork.aseSubnetAddressCidrRange, '/')), '.'), 3))), true)]",
                                                "message": "CIDR range not within virtual network CIDR range (third octet)."
                                            },
                                            {
                                                "isValid": "[lessOrEquals(last(split(steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange, '/')), last(split(steps('spoke').spokeVirtualNetwork.aseSubnetAddressCidrRange, '/')))]",
                                                "message": "CIDR range not within virtual network CIDR range (subnet mask)."
                                            }
                                        ]
                                    }
                                }
                            ]
                        },
                        {
                            "name": "managementVm",
                            "label": "Management Virtual Machine",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "vmCredentials",
                                    "type": "Microsoft.Compute.CredentialsCombo",
                                    "label": {
                                        "password": "Password",
                                        "confirmPassword": "Confirm password"
                                    },
                                    "toolTip": {
                                        "password": ""
                                    },
                                    "constraints": {
                                        "required": true,
                                        "customPasswordRegex": "^(?=.*\\d)(?=.*[a-z])(?=.*[A-Z])[\\w~@#$%^&*+=|{}:;!.?\\()\\[\\]-]{8,}$",
                                        "customValidationMessage": "The password must contain at least 8 characters, with at least 1 uppercase, 1 lowercase and 1 number."
                                    },
                                    "options": {
                                        "hideConfirmation": false
                                    },
                                    "osPlatform": "Windows",
                                    "visible": true,
                                    "resourceTypeMetadata": []
                                }
                            ]
                        },
                        {
                            "name": "dns",
                            "label": "Public DNS",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "dnsZone",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Domain Name (Global)",
                                    "defaultValue": "",
                                    "constraints": {
                                        "required": true
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "certificates",
                    "label": "Certificates",
                    "elements": [
                        {
                            "name": "infoBoxLocation",
                            "type": "Microsoft.Common.InfoBox",
                            "options": {
                                "text": "Please upload the web application certificate as a PFX file to a storage account in the Hub subscription. Once completed, please select the certificate using the interace below and supply the password for the certificate.",
                                "style": "Info"
                            }
                        },
                        {
                            "name": "storageBlobSelection",
                            "type": "Microsoft.Storage.StorageBlobSelector",
                            "visible": true,
                            "toolTip": "Select certificate for application",
                            "label": "Certificate File(.pfx)",
                            "options": {
                                "text": "Select Certificate"
                            },
                            "constraints": {
                                "allowedFileExtensions": [
                                    "pfx"
                                ]
                            },
                            "scope": {
                                "subscriptionId": "[replace(steps('basics').hubSection.hubSubscriptionId, '/subscriptions/', '')]"
                            }
                        },
                        {
                            "name": "certificate",
                            "label": "Certificate Password",
                            "type": "Microsoft.Common.Section",
                            "elements": [
                                {
                                    "name": "password",
                                    "type": "Microsoft.Common.PasswordBox",
                                    "label": {
                                        "password": "Password",
                                        "confirmPassword": "Confirm password"
                                    },
                                    "toolTip": "",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-zA-Z0-9]{8,}$",
                                        "validationMessage": "Password must be at least 8 characters long, contain only numbers and letters"
                                    },
                                    "options": {
                                        "hideConfirmation": false
                                    },
                                    "visible": true
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "outputs": {
            "parameters": {
				"appGwSubnetAddressPrefix":"[steps('spoke').spokeVirtualNetwork.appGwSubnetAddressCidrRange]",
				"applicationGatewaySslCertificatePassword":"[steps('certificates').certificate.password]",
				"aseSubnetAddressPrefix":"[steps('spoke').spokeVirtualNetwork.aseSubnetAddressCidrRange]",
				"azureFirewallName": "[steps('hub').hubResources.firewall.name]",
				"dnsZoneName":"[steps('spoke').dns.dnsZone]",
				"hubResourceGroup":"[first(skip(split(steps('hub').hubResources.firewall.id, '/'), 4))]",
				"hubStorageAccountContainerName":"[first(skip(split(steps('certificates').storageBlobSelection.sasUri, '/'), 3))]",
				"hubStorageAccountName":"[first(skip(split(steps('certificates').storageBlobSelection.sasUri, '.'), 1))]",
				"hubVirtualNetworkName":"[steps('hub').hubResources.hubVirtualNetwork.name]",
				"localAdministratorPassword":"[steps('spoke').managementVm.vmCredentials.password]",
				"managementVirtualMachineSubnetAddressPrefix":"[steps('spoke').spokeVirtualNetwork.mgmtSubnetAddressCidrRange]",
				"spokeResourceGroup": "[steps('spoke').spokeResourceGroupName.vmCredentials]",
				"vNetAddressPrefixes":"[steps('spoke').spokeVirtualNetwork.spokeVirtualNetworkAddressCidrRange]",
                "applicationGatewaySslCertificateFilename": "[steps('certificates').storageBlobSelection.blobName]",
                "hubSubscriptionId": "[replace(steps('basics').hubSection.hubSubscriptionId, '/subscriptions/', '')]",
                "location":"[steps('basics').locationSection.location]",
                "spokeSubscriptionId": "[replace(steps('basics').spokeSection.spokeSubscriptionId, '/subscriptions/', '')]"
            },
            "kind": "Subscription",
            "subscriptionId": "[steps('basics').spokeSection.spokeSubscriptionId]",
            "location": "[steps('basics').locationSection.location]"
        }
    }
}